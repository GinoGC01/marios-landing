---
// src/components/showcase/ImpulseSlider.astro
const examples = [
  { 
    title: "Milagro - Lashista profesional", 
    url: "https://mili-lashes.vercel.app", 
    thumbnail: "../thumbnails/mili-lashes.webp",
    tag: "ASTRO_V5"
  },
  { 
    title: "Axel Sotelo - Personal Trainer", 
    url: "https://axel-fitness.vercel.app", 
    thumbnail: "../thumbnails/perfil-axel.webp",
    tag: "ASTRO_V5"
  },
  { 
    title: "RG Cargas - Logística & Mudanzas", 
    url: "https://rg-cargas.vercel.app", 
    thumbnail: "../thumbnails/rg-cargas.webp",
    tag: "ASTRO_V5"
  }
];
---

<div class="relative mb-24 animate-entry" style="transition-delay: 850ms;">
  <h2 class="font-mono text-xs text-gray-500 mb-8 uppercase tracking-widest flex items-center gap-4">
    <span>02. Prototipos en Producción</span>
    <span class="h-px bg-white/10 flex-1"></span>
  </h2>

  <div class="relative group/slider">
    <button id="prev-slide" class="hidden md:flex absolute -left-6 top-1/2 -translate-y-1/2 z-20 w-12 h-12 items-center justify-center bg-[#0a0a0f] border border-white/10 text-white opacity-0 group-hover/slider:opacity-100 transition-all hover:border-[#00ffff] hover:text-[#00ffff]">
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m15 18-6-6 6-6"/></svg>
    </button>

    <div id="slider-container" class="flex gap-6 overflow-x-auto pb-8 scrollbar-hide snap-x snap-mandatory scroll-smooth touch-pan-x">
      {examples.map((ex) => (
        <div 
          class="example-trigger group relative min-w-[300px] md:min-w-[450px] aspect-[16/10] bg-[#0a0a0f] border border-white/10 overflow-hidden cursor-pointer snap-start transition-all hover:border-[#00ffff]"
          data-url={ex.url}
          data-title={ex.title}
        >
          <img src={ex.thumbnail} alt={ex.title} class="w-full h-full object-cover opacity-40 group-hover:opacity-70 transition-all duration-700" />
          
          <div class="absolute inset-0 p-6 flex flex-col justify-end bg-gradient-to-t from-[#050505] via-transparent to-transparent">
            <span class="text-[10px] font-mono text-[#00ffff] mb-2 tracking-[0.2em] opacity-0 group-hover:opacity-100 transition-all">
              [ VER_DEMO_INTERACTIVA ]
            </span>
            <h4 class="text-white font-bold text-xl tracking-tighter">{ex.title}</h4>
          </div>
        </div>
      ))}
    </div>

    <button id="next-slide" class="hidden md:flex absolute -right-6 top-1/2 -translate-y-1/2 z-20 w-12 h-12 items-center justify-center bg-[#0a0a0f] border border-white/10 text-white opacity-0 group-hover/slider:opacity-100 transition-all hover:border-[#00ffff] hover:text-[#00ffff]">
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m9 18 6-6-6-6" transform="rotate(180 12 12)"/></svg>
    </button>
  </div>
</div>

<div id="browser-modal" class="fixed inset-0 z-[100] hidden flex items-center justify-center px-4 md:p-12 backdrop-blur-sm">
  <div class="relative w-full max-w-7xl h-[90%] flex flex-col bg-[#0a0a0f] border border-white/10 overflow-hidden shadow-2xl">
    
    <div class="flex items-center gap-4 px-4 py-3 bg-[#161616] border-b border-white/10">
      <div class="flex gap-2">
        <button id="close-browser" class="w-3 h-3 rounded-full bg-red-500 hover:brightness-125 transition-all"></button>
        <div class="w-3 h-3 rounded-full bg-yellow-500"></div>
        <div class="w-3 h-3 rounded-full bg-green-500"></div>
      </div>
      <div class="flex-1 bg-black/50 rounded px-3 py-1 text-[10px] text-white/40 font-mono truncate text-center">
        HTTPS://<a href="" id="modal-url-display" target="_blank" class="hover:text-[#00ffff] transition-colors">...</a>
      </div>
      <button id="close-browser-x" class="text-white/20 hover:text-white transition-colors p-1">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
      </button>
    </div>

    <div class="relative bg-[#08080a] border-b border-white/10 px-3 py-2 md:px-8 md:py-3">
      <div class="flex items-center justify-between gap-2">
        
        <div class="flex items-center gap-3 md:gap-6">
          {/* Precio Inversión */}
          <div class="flex flex-col md:block">
            <span class="hidden md:block text-[8px] font-mono text-gray-500 uppercase tracking-wider mb-0.5">Inversión Inicial</span>
            <div class="flex items-baseline gap-1">
              <span class="text-sm md:text-xl font-bold text-white tracking-tighter">$0</span>
              <span class="text-[7px] md:text-[9px] text-gray-500 font-mono">/setup</span>
            </div>
          </div>

          <div class="w-px h-6 md:h-8 bg-white/10"></div>

          {/* Precio Operativo */}
          <div class="flex items-center md:bg-white/[0.03] md:px-3 md:py-1.5 md:border md:border-white/5 md:rounded-md">
            <div class="flex flex-col md:block">
              <span class="hidden md:block text-[8px] font-mono text-[#00ffff] uppercase tracking-wider mb-0.5 opacity-80">Costo Operativo</span>
              <div class="flex items-baseline gap-1">
                <span class="text-sm md:text-xs font-bold text-white md:text-white">+ $20</span>
                <span class="text-[7px] md:text-[9px] text-gray-500">/mes</span>
              </div>
            </div>
          </div>
        </div>

        {/* Boton Minimalista */}
        <a 
          id="modal-wa-button"
          href="#" 
          target="_blank"
          class="bg-white text-black px-3 py-2 md:px-6 md:py-2.5 font-bold text-[9px] md:text-[10px] uppercase hover:bg-[#00ffff] transition-all clip-path-slant flex items-center justify-center gap-2 group"
        >
          <span class="hidden xs:inline">Solicitar Plan</span>
          <span class="inline xs:hidden">Aplicar</span>
          <svg class="w-3 h-3 group-hover:translate-x-1 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3"/></svg>
        </a>
      </div>
      <div class="absolute bottom-0 left-0 h-[1px] w-full bg-gradient-to-r from-transparent via-[#00ffff]/20 to-transparent"></div>
    </div>

    <div class="flex-1 bg-white relative">
      <div id="browser-loader" class="absolute inset-0 flex items-center justify-center bg-[#0a0a0f] z-10">
        <div class="w-8 h-8 border-2 border-[#00ffff] border-t-transparent rounded-full animate-spin"></div>
      </div>
      <iframe id="browser-iframe" class="w-full h-full border-none opacity-0 transition-opacity duration-500" src=""></iframe>
    </div>
  </div>
</div>

<script>
  function setupImpulseLogic() {
    const slider = document.getElementById('slider-container');
    const prevBtn = document.getElementById('prev-slide');
    const nextBtn = document.getElementById('next-slide');
    const triggers = document.querySelectorAll('.example-trigger');
    const modal = document.getElementById('browser-modal');
    const iframe = document.getElementById('browser-iframe') as HTMLIFrameElement;
    const urlDisplay = document.getElementById('modal-url-display') as HTMLAnchorElement;
    const modalWaButton = document.getElementById('modal-wa-button') as HTMLAnchorElement;
    const loader = document.getElementById('browser-loader');
    const closeBtn = document.getElementById('close-browser');
    const closeBtnX = document.getElementById('close-browser-x');
    const mainBar = document.getElementById('main-action-bar');
    const mainNav = document.getElementById('main-nav');

    let autoScrollTimer: number;
    let isPaused = false;

    const moveSlider = (direction: 'next' | 'prev') => {
      if (!slider) return;
      const card = slider.querySelector('.example-trigger');
      if (!card) return;
      const scrollAmount = card.clientWidth + 24; // ancho + gap

      if (direction === 'next') {
        if (slider.scrollLeft + slider.offsetWidth >= slider.scrollWidth - 10) {
          slider.scrollTo({ left: 0, behavior: 'smooth' });
        } else {
          slider.scrollBy({ left: scrollAmount, behavior: 'smooth' });
        }
      } else {
        slider.scrollBy({ left: -scrollAmount, behavior: 'smooth' });
      }
    };

    const startTimer = () => {
      autoScrollTimer = window.setInterval(() => {
        if (!isPaused) moveSlider('next');
      }, 3500);
    };

    nextBtn?.addEventListener('click', () => { moveSlider('next'); clearInterval(autoScrollTimer); startTimer(); });
    prevBtn?.addEventListener('click', () => { moveSlider('prev'); clearInterval(autoScrollTimer); startTimer(); });

    slider?.addEventListener('mouseenter', () => isPaused = true);
    slider?.addEventListener('mouseleave', () => isPaused = false);
    slider?.addEventListener('touchstart', () => { isPaused = true; }, { passive: true });
    slider?.addEventListener('touchend', () => { setTimeout(() => isPaused = false, 2000); }, { passive: true });

    startTimer();

    triggers.forEach(trigger => {
      trigger.addEventListener('click', () => {
        isPaused = true;
        const url = trigger.getAttribute('data-url');
        const title = trigger.getAttribute('data-title');
        
        if (url && modal && iframe && urlDisplay) {
          iframe.src = url;
          urlDisplay.textContent = url.replace('https://', '').toUpperCase();
          urlDisplay.href = url;
          
          if (modalWaButton) {
            const message = encodeURIComponent(`Hola, estoy viendo el ejemplo "${title}" y me interesa aplicar al Plan Impulse.`);
            modalWaButton.href = `https://wa.me/5491140230671?text=${message}`;
          }

          modal.classList.remove('hidden');
          document.body.style.overflow = 'hidden';

          if (mainBar) mainBar.style.transform = 'translateY(110%)';
          if (mainNav) mainNav.style.transform = 'translateY(-110%)';
          
          iframe.onload = () => {
            loader?.classList.add('hidden');
            iframe.classList.replace('opacity-0', 'opacity-100');
          };
        }
      });
    });

    const closeHandler = () => {
      if (modal && iframe) {
        modal.classList.add('hidden');
        iframe.src = "";
        iframe.classList.replace('opacity-100', 'opacity-0');
        loader?.classList.remove('hidden');
        document.body.style.overflow = 'auto';
        isPaused = false;
        if (mainBar) mainBar.style.transform = 'translateY(0)';
        if (mainNav) mainNav.style.transform = 'translateY(0)';
      }
    };

    closeBtn?.addEventListener('click', closeHandler);
    closeBtnX?.addEventListener('click', closeHandler);
    modal?.addEventListener('click', (e) => { if(e.target === modal) closeHandler(); });
  }

  setupImpulseLogic();
  document.addEventListener('astro:page-load', setupImpulseLogic);
</script>

<style>
  .scrollbar-hide::-webkit-scrollbar { display: none; }
  .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
  .clip-path-slant { clip-path: polygon(10px 0, 100% 0, 100% calc(100% - 10px), calc(100% - 10px) 100%, 0 100%, 0 10px); }
  #modal-wa-button { background-color: white; color: black; }
  #modal-wa-button:hover { background-color: #00ffff; }
</style>